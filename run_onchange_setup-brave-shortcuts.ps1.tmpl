param (
    [string]$ShortcutDir = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Custom Web Apps",
    [string]$IconCacheDir = "$env:LOCALAPPDATA\BraveShortcutIcons"
)
 
function Resolve-BraveProfileFolderName {
    param (
        [Parameter(Mandatory = $true)]
        [string]$DisplayName
    )

    $localStatePath = "$env:LOCALAPPDATA\BraveSoftware\Brave-Browser\User Data\Local State"

    if (-not (Test-Path $localStatePath)) {
        Write-Error "Local State file not found."
        return $null
    }

    $json = Get-Content $localStatePath -Raw | ConvertFrom-Json
    $infoCache = $json.profile.info_cache

    foreach ($folder in $infoCache.PSObject.Properties.Name) {
        $profileInfo = $infoCache.$folder
        $name = $profileInfo.name
        if ($name -eq $DisplayName) {
            return $folder
        }
    }

    Write-Error "Could not find Brave profile with display name '$DisplayName'"
    return $null
}

<#
{{- $apps := include ".chezmoidata/braveapps.yaml" | fromYaml -}}
#>

# Generated by chezmoi from braveapps.yaml

New-Item -ItemType Directory -Force -Path $ShortcutDir | Out-Null
New-Item -ItemType Directory -Force -Path $IconCacheDir | Out-Null

$WshShell = New-Object -ComObject WScript.Shell

<# begin app loop #>
{{- range $apps.brave_apps }}
$name = "{{ .name }}"
$url = "{{ .url }}"

Write-output "Working on shortcut for $name"
# Reset icon-related vars
$faviconUrl = $null
$domain = $null
$iconBase = $null

{{- if (index . "iconurl") }}
$faviconUrl = "{{ .iconurl }}"
$iconBase = "custom_icon_{{ .name | replace " " "_" }}"
{{- else }}
$icondomain = "{{ if (index . "icondomain") }}{{ .icondomain }}{{ else }}{{ .url }}{{ end }}"
$domain = ([uri]$icondomain).Host
$faviconUrl = "https://www.google.com/s2/favicons?sz=64&domain=$domain"
$iconBase = "$($domain.Replace('.', '_'))"
{{- end }}

$extension = [System.IO.Path]::GetExtension($faviconUrl).ToLower()

$iconPng = Join-Path $IconCacheDir "$iconBase$extension"
$iconIco = Join-Path $IconCacheDir "$iconBase.ico"

$shortcutPath = Join-Path $ShortcutDir "$name.lnk"

# Download if not cached
if (-not (Test-Path $iconPng)) {
    try {
        Invoke-WebRequest -Uri $faviconUrl -OutFile $iconPng -ErrorAction Stop
    } catch {
        Write-Warning "Failed to fetch icon for $name"
    }
}

# Convert PNG to ICO only if needed
if ($extension -ne ".ico" -and (Test-Path $iconPng) -and (-not (Test-Path $iconIco))) {
    try {
        python $home/bin/convert_png_to_ico.py "$iconPng" "$iconIco"
    } catch {
        Write-Warning "Failed to convert favicon for $name to ICO"
    }
} elseif ($extension -eq ".ico") {
    if ($iconPng -ne $iconIco) {
        Copy-Item $iconPng $iconIco -Force
    }
}


# Create shortcut
$folderName = Resolve-BraveProfileFolderName "{{- .profile -}}"
$shortcut = $WshShell.CreateShortcut($shortcutPath)
$shortcut.TargetPath = "C:\Program Files\BraveSoftware\Brave-Browser\Application\brave.exe"
$shortcut.Arguments = "--profile-directory=""$folderName"" --app=$url"
$iconLocation =  if (Test-Path $iconIco) { "$iconIco,0" } else { "$shortcut.TargetPath,0" }
$shortcut.IconLocation = $iconLocation
$shortcut.Save()
Write-Output "Created/updated shortcut: $name"
Write-Output "Icon was used from $iconLocation"

{{- end }}
<# end app loop #>

