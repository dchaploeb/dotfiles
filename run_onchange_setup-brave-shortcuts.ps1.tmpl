<#
{{- $apps := include ".chezmoidata/braveapps.yaml" | fromYaml -}}
#>

# Generated by chezmoi from braveapps.yaml

param (
    [string]$ShortcutDir = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Custom Web Apps",
    [string]$IconCacheDir = "$env:LOCALAPPDATA\BraveShortcutIcons"
)

New-Item -ItemType Directory -Force -Path $ShortcutDir | Out-Null
New-Item -ItemType Directory -Force -Path $IconCacheDir | Out-Null

$WshShell = New-Object -ComObject WScript.Shell

<# begin app loop #>
{{- range $apps.brave_apps }}
$name = "{{ .name }}"
$url = "{{ .url }}"
$domain = ([uri]$url).Host
$iconBase = "$($domain.Replace('.', '_'))"
$iconPng = Join-Path $IconCacheDir "$iconBase.png"
$iconIco = Join-Path $IconCacheDir "$iconBase.ico"
$shortcutPath = Join-Path $ShortcutDir "$name.lnk"

# Download favicon PNG if not cached
if (-not (Test-Path $iconPng)) {
    $faviconUrl = "https://www.google.com/s2/favicons?sz=64&domain=$domain"
    try {
        Invoke-WebRequest -Uri $faviconUrl -OutFile $iconPng -ErrorAction Stop
    } catch {
        Write-Warning "Failed to fetch icon for $name"
    }
}

# Convert PNG to ICO if missing
if ((Test-Path $iconPng) -and (-not (Test-Path $iconIco))) {
    try {
        magick "$iconPng" -define icon:auto-resize=64,48,32,16 "$iconIco"
    } catch {
        Write-Warning "Failed to convert favicon for $name to ICO"
    }
}

# Create shortcut
$shortcut = $WshShell.CreateShortcut($shortcutPath)
$shortcut.TargetPath = "C:\Program Files\BraveSoftware\Brave-Browser\Application\brave.exe"
$shortcut.Arguments = "--profile-directory=Default --app=$url"
$shortcut.IconLocation = if (Test-Path $iconIco) { "$iconIco,0" } else { "$shortcut.TargetPath,0" }
$shortcut.Save()
Write-Output "Created/updated shortcut: $name"

{{- end }}
<# end app loop #>
